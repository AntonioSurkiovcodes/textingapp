<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Messenger Clone</title>
<style>
body{margin:0;background:#000;color:white;font-family:Arial,sans-serif;display:flex;height:100vh;overflow:hidden;}
#sidebar{width:280px;background:#121212;border-right:1px solid #333;display:flex;flex-direction:column;}
#meBox{padding:20px;border-bottom:1px solid #333;}
#meName{width:100%;padding:10px;background:#1f1f1f;border:none;border-radius:6px;color:white;}
#saveNameBtn{margin-top:10px;width:100%;padding:10px;background:#0064ff;border:none;border-radius:6px;color:white;cursor:pointer;}
#refreshBtn{margin:10px;padding:10px;background:#333;border:none;color:white;border-radius:6px;cursor:pointer;}
#usersList{flex:1;overflow-y:auto;}
.userItem{padding:15px;border-bottom:1px solid #222;cursor:pointer;}
.userItem:hover{background:#1c1c1c;}
#chatArea{flex:1;display:flex;flex-direction:column;}
#chatHeader{padding:15px;background:#121212;border-bottom:1px solid #333;font-size:20px;}
#messages{flex:1;padding:15px;overflow-y:auto;}
.msg{max-width:60%;padding:10px 14px;border-radius:10px;margin-bottom:10px;}
.me{background:#0064ff;margin-left:auto;}
.them{background:#1f1f1f;margin-right:auto;}
#inputBox{display:flex;padding:15px;background:#121212;border-top:1px solid #333;}
#msgText{flex:1;padding:10px;background:#1f1f1f;border:none;border-radius:6px;color:white;}
#sendBtn{margin-left:10px;padding:10px 18px;background:#0064ff;border:none;border-radius:6px;color:white;cursor:pointer;}
</style>
</head>
<body>

<div id="sidebar">
  <div id="meBox">
    <input id="meName" placeholder="Въведи име..." />
    <button id="saveNameBtn">Запази име</button>
    <button id="refreshBtn">Обнови</button>
  </div>
  <div id="usersList"></div>
</div>

<div id="chatArea">
  <div id="chatHeader">Избери човек</div>
  <div id="messages"></div>
  <div id="inputBox">
    <input id="msgText" placeholder="Пиши тук..." />
    <button id="sendBtn">Изпрати</button>
  </div>
</div>

<script>
let me="";
let currentChat=null;

// Save your name to localStorage
saveNameBtn.onclick = () => {
  me = meName.value.trim();
  if(!me) return;
  let allUsers = JSON.parse(localStorage.getItem("liveUsers")||"[]");
  if(!allUsers.includes(me)) allUsers.push(me);
  localStorage.setItem("liveUsers", JSON.stringify(allUsers));
  renderUsers();
  alert("Името е запазено!");
};

// Render users from localStorage
function renderUsers() {
  const box = document.getElementById("usersList");
  box.innerHTML = "";
  const allUsers = JSON.parse(localStorage.getItem("liveUsers")||"[]");
  allUsers.filter(u => u !== me).forEach(u => {
    const div = document.createElement("div");
    div.className="userItem";
    div.textContent=u;
    div.onclick=()=>openChat(u);
    box.appendChild(div);
  });
}

// Refresh users
refreshBtn.onclick = renderUsers;

// Open chat with a user
function chatID(a,b){ return "chat:"+[a,b].sort().join("|"); }

function openChat(user){
  currentChat=user;
  chatHeader.textContent=user;
  loadMessages();
}

// Load messages from localStorage
function loadMessages(){
  if(!currentChat) return;
  const msgBox = messages;
  const id = chatID(me,currentChat);
  if(!localStorage.getItem(id)) localStorage.setItem(id, JSON.stringify([]));
  const arr = JSON.parse(localStorage.getItem(id));
  msgBox.innerHTML="";
  arr.forEach(m=>{
    const div = document.createElement("div");
    div.className="msg "+(m.from===me?"me":"them");
    div.textContent=m.text;
    msgBox.appendChild(div);
  });
  msgBox.scrollTop=msgBox.scrollHeight;
}

// Send message
sendBtn.onclick = () => {
  if(!currentChat) return alert("Избери човек!");
  const text = msgText.value.trim();
  if(!text) return;
  const id = chatID(me,currentChat);
  const arr = JSON.parse(localStorage.getItem(id)||"[]");
  arr.push({from:me,text});
  localStorage.setItem(id, JSON.stringify(arr));
  msgText.value="";
  loadMessages();
}

// Auto refresh messages and users every second
setInterval(()=>{
  renderUsers();
  if(currentChat) loadMessages();
},1000);
</script>

</body>
</html>
